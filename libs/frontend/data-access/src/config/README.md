<!-- Generated by AI -->

# Environment Configuration System

A comprehensive environment variable management system for Next.js applications with both server-side and client-side support, intelligent caching, and type safety.

## Features

-   ‚úÖ **Universal Support** - Works on both server-side and client-side
-   ‚úÖ **Type Safety** - Full TypeScript support with `EnvVariables` type
-   ‚úÖ **Intelligent Caching** - Memory cache + sessionStorage for optimal performance
-   ‚úÖ **React Integration** - `useEnv` hook with loading states and error handling
-   ‚úÖ **Hot Refresh** - Force refresh capability for development
-   ‚úÖ **Runtime Configuration** - Dynamic environment loading via API route

## Architecture Overview

### Core Files

1. **`libs/frontend/data-access/src/config/env.ts`**

    - Core environment variable management
    - Server/client detection and appropriate loading strategies
    - Memory and sessionStorage caching

2. **`libs/frontend/data-access/src/hooks/useEnv.ts`**

    - React hook for environment variables
    - Loading states, error handling, and refresh capabilities
    - Automatic environment loading on component mount

3. **`apps/web-app/src/app/api/env/route.ts`**
    - Next.js API route that serves environment variables to client
    - Dynamic route that reads from `process.env`

## Environment Variables Configuration

### Runtime Environment Sources

The environment variable system adapts to different environments:

**üè† Local Development:**

-   Variables are read from `.env.local`, `.env.development`, and other Next.js environment files

**‚òÅÔ∏è Deployed Environments (AWS ECS):**

-   Variables are injected at runtime from AWS ECS container environment
-   Set via ECS Task Definition environment variables

**üîÑ Runtime Flow:**

```
Local: .env files ‚Üí process.env ‚Üí /api/env ‚Üí Client
Deployed: ECS Container ‚Üí process.env ‚Üí /api/env ‚Üí Client
```

The same `/api/env` route serves variables from the appropriate source based on the environment.

### 1. Define Environment Keys

All environment variables must be defined in the `ENV_KEYS` array:

```typescript
// libs/frontend/data-access/src/config/env.ts
export const ENV_KEYS = [
    'API_AUTHENTICATION_URL',
    'API_USER_URL',
    'BYPASS_AUTH',
    'LOCALSTACK_STATUS',
    'WEBSOCKET_URL',
    'WEBSOCKET_LOCAL_URL',
    'PING_INTERVAL',
    'DEFAULT_REGION',
    'AWS_SECRET_ID',
    'S3_NX_TEMPLATE_V2_LOCAL_DATA',
    'NODE_ENV',
] as const;
```

‚ö†Ô∏è **Important**: Only variables listed in `ENV_KEYS` will be available to the client-side application.

### 2. Environment Configuration

**For Local Development:**

Set up environment variables in `.env` files:

```bash
# .env.local (for local development)
API_AUTHENTICATION_URL=http://localhost:3001/api/auth
API_USER_URL=http://localhost:3002/api/user
LOCALSTACK_STATUS=ENABLED
WEBSOCKET_LOCAL_URL=http://localhost:3001
BYPASS_AUTH=ENABLED
```

**For Deployed Environments:**

Environment variables are configured in AWS ECS Task Definition, not files. Example values:

```bash
# Set in ECS Task Definition environment variables
API_AUTHENTICATION_URL=https://api.example.com/auth
API_USER_URL=https://api.example.com/user
LOCALSTACK_STATUS=DISABLED
WEBSOCKET_URL=wss://websocket.example.com
BYPASS_AUTH=DISABLED
```

## Usage

### React Components

```typescript
import { useEnv } from '@data-access/hooks/useEnv';

const MyComponent = () => {
    const { env, loading, error } = useEnv();

    if (loading) return <div>Loading...</div>;
    if (error) return <div>Error: {error}</div>;

    return <div>API URL: {env.API_USER_URL}</div>;
};
```

### API Classes

```typescript
import { AxiosConfig } from '@data-access/api/axiosConfig';

class UserApi extends AxiosConfig {
    constructor() {
        super('API_USER_URL', true, false);
    }

    async getProfile() {
        return await this.axiosInstance.get('/profile');
    }
}
```

üìù **Note**: `getEnv()` is already integrated within `AxiosConfig` - it automatically resolves the environment variable specified in the constructor and sets the base URL.

### Server-Side

```typescript
import { getEnv } from '@data-access/config/env';

export async function GET() {
    const env = await getEnv();
    // Use env variables directly
}
```

## API Reference

### `useEnv()` Hook

React hook that provides environment variables with loading states:

```typescript
interface UseEnvReturn {
    env: EnvVariables; // Current environment variables
    loading: boolean; // True while fetching environment
    error: string | null; // Error message if fetch failed
    refresh: (forceRefresh?: boolean) => Promise<void>; // Refresh environment
}
```

**Parameters:**

-   None

**Returns:**

-   `env` - Object containing all environment variables
-   `loading` - Loading state (true during initial load or refresh)
-   `error` - Error message if environment loading failed
-   `refresh(forceRefresh?)` - Function to reload environment variables

**Example:**

```typescript
const { env, loading, error, refresh } = useEnv();

// Check loading state
if (loading) return <Spinner />;

// Handle errors
if (error) return <ErrorMessage error={error} />;

// Use environment variables
console.log('API URL:', env.API_USER_URL);

// Force refresh
await refresh(true);
```

### `getEnv(forceRefresh?)` Function

Asynchronous function to get environment variables:

```typescript
async function getEnv(forceRefresh = false): Promise<EnvVariables>;
```

**Parameters:**

-   `forceRefresh` (optional) - Bypass cache and fetch fresh values

**Returns:**

-   Promise that resolves to `EnvVariables` object

**Example:**

```typescript
// Get cached environment (recommended)
const env = await getEnv();

// Force refresh from server
const freshEnv = await getEnv(true);
```

### `getInitialEnvState()` Function

Synchronous function to get immediately available environment state:

```typescript
function getInitialEnvState(): EnvVariables;
```

**Returns:**

-   `EnvVariables` object (may contain empty strings if not cached)

**Example:**

```typescript
// Get initial state for React useState
const [env, setEnv] = useState(getInitialEnvState);
```

### `clearEnvCache()` Function

Clears both memory and sessionStorage cache:

```typescript
function clearEnvCache(): void;
```

**Example:**

```typescript
// Clear cache and force fresh fetch
clearEnvCache();
const freshEnv = await getEnv();
```

## Caching Strategy

### Three-Layer Caching System

```
1. Memory Cache (Primary)
   ‚îú‚îÄ‚îÄ In-memory storage for fastest access
   ‚îú‚îÄ‚îÄ Cleared on page refresh
   ‚îî‚îÄ‚îÄ Shared across all components

2. SessionStorage Cache (Secondary)
   ‚îú‚îÄ‚îÄ Persists across page refreshes
   ‚îú‚îÄ‚îÄ Cleared when browser tab closes
   ‚îî‚îÄ‚îÄ Client-side only

3. API Route (Source of Truth)
   ‚îú‚îÄ‚îÄ Fetches from process.env
   ‚îú‚îÄ‚îÄ Always up-to-date
   ‚îî‚îÄ‚îÄ Used when caches are empty
```

## Best Practices

-   ‚úÖ Use `useEnv()` hook in React components for loading states
-   ‚úÖ Extend `AxiosConfig` for API classes with environment URLs
-   ‚úÖ Handle loading and error states properly
-   ‚úÖ Only expose public configuration (no secrets)

## Security Notes

‚ö†Ô∏è **Important**: All variables in `ENV_KEYS` are exposed to the client browser. Only include public configuration, never secrets or private keys.
